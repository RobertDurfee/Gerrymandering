const express = require('express')
const http = require('http')
const uuid = require('uuid').v4

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Global Constants
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const LOG_OPTIONS = {
  'color': true,
  'depth': null,
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Helper Functions
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const prettify = name => {
  if (name) {
    const words = name.split('_')
    for (let i = 0; i < words.length; i++) {
      words[i] = words[i][0].toUpperCase() + words[i].slice(1)
    }
    return words.join(' ')
  }
}

const district = name => {
  if (name === 'Assembly' || name === 'Senate' || name === 'Congressional') {
    return name + ' District'
  }
  return name
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Logging Functions
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const logRequest = (id, req) => {
  console.dir({
    'id': id,
    'request': {
      'method': req['method'],
      'url': req['url'],
      'params': req['params'],
      'query': req['query'],
      'body': req['body']
    }
  }, LOG_OPTIONS)
}

const logResponse = (id, res) => {
  console.dir({
    'id': id,
    'response': {
      'statusCode': res['statusCode'],
      'statusMessage': res['statusMessage'],
    }
  }, LOG_OPTIONS)
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// App Configuration
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const app = express()

app.set('view engine', 'pug')

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// REST Methods
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

app.get('/states/:state/races/:race/years/:year/votes', (req, res) => {
  const id = uuid()
  logRequest(id, req)

  const state = req.params['state']
  const race = req.params['race']
  const year = req.params['year']
  const base = req.query['base'] || 'ward'
  const overlay = req.query['overlay']

  res.render('votes', {
    state: prettify(state),
    year: year,
    race: prettify(race),
    base: district(prettify(base)),
    overlay: district(prettify(overlay)),
    baseURI: `/states/${state}/races/${race}/years/${year}/votes?group=${base}`,
    overlayURI: `/states/${state}/races/${race}/years/${year}/votes?group=${overlay}`,
  })

  logResponse(id, res)
})

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Connect
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

http.createServer(app).listen(8007)
